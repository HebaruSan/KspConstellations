CONTRACT_TYPE
{
	sortKey = g

	name = KolyniaConstellation
	group = KerbinConstellations

	title = "Launch a satellite into "+@/targetBody+"'s kolynia orbit"

	description = Kerbals @/direction2 are complaining about having a bad signal from kerbostationary satellites. A couple of satellites in a high-inclination high-eccentricity orbit should help with coverage in high latitudes.
	genericDescription = "Launch a satellite into "+@/targetBody+"'s kolynia orbit"

	completedMessage = The satellite is in position and working!

	maxSimultaneous = 1

	synopsis = "Launch a satellite into "+@/targetBody+"'s kolynia orbit"

	prestige = Trivial

	maxExpiry = 21

	targetBody = HomeWorld()

	notes = Required deltaV from Low @/targetBody Orbit: @/deltaV.Print() m/s \nDon't forget to leave some fuel for station-keeping!

	DATA
	{
		type = double

		inc = 63.4
		sma = Pow((@/targetBody.GM() * Pow(@/targetBody.RotationalPeriod() / 2, 2)) / 39.478417604357432, 0.3333333333333333)
		ecc = 0.74
	}

	rewardScience = 0
	rewardReputation = 12
	rewardFunds = 40 * HomeWorld().Radius() / 600
	advanceFunds = @rewardFunds / 4
	failureReputation = @rewardReputation
	failureFunds = @advanceFunds

	DATA
	{
		type = int
		idx = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11].SelectUnique()
		uniquenessCheck = CONTRACT_ALL
		hidden = true
	}

	DATA
	{
		type = List<string>
		directions = ["south", "north"]
		directions2 = ["down south", "up north"]
	}

	DATA
	{
		type = string
		direction = @/directions.ElementAt(@/idx / 6)
		direction2 = @/directions2.ElementAt(@/idx / 6)
		letter = ["S1", "S2", "S3", "S4", "S5", "S6", "N1", "N2", "N3", "N4", "N5", "N6"].ElementAt(@/idx)
		sat = Kolynia Sat @/letter
		hidden = true
	}

	DATA
	{
		type = double
		rng = Random()
	}

	REQUIREMENT
	{
		name = Rng
		type = Expression
		expression = @/rng > 0.5
		checkOnActiveContract = false
		title = Random chance
	}

	REQUIREMENT
	{
		name = CompleteContract
		type = CompleteContract

		contractType = KSOSatellite
	}

	BEHAVIOUR
	{
		name = SpawnVessel
		type = SpawnVessel

		VESSEL
		{
			name = Kolynia Satellite Marker
			craftPart = constellations-dummy
			owned = False
			targetBody = @/targetBody
			vesselType = DroppedPart

			ORBIT
			{
				SMA = @/sma
				ECC = @/ecc
				INC = @/inc
				LPE = (@/idx / 6) * 180 + 90
				LAN = (@/idx / 4) * 120
				MNA = Mod(@/idx, 2) * 3.1415926536
				EPH = 0
				REF = 0 // ignored
			}
		}
	}

	DATA
	{
		type = double

		sensitivity = 2 * Pow(@/sma, 1.5) / Pow(Max(1, @/targetBody.GM()), 0.5) // rate of change of sma in relation to orbital velocity
		multiple = Pow(10, Round(Log(@sensitivity, 10) - 0.5))
		coeff = Round(@sensitivity, @multiple) // sensitivity rounded to a nice round number

		altThreshold1 = Round(@coeff / 2, @multiple)
		altThreshold2 = Round(@coeff / 40, @multiple / 10)
		altThreshold3 = Round(@coeff / 7500 + 0.5) / 2
		distThreshold1 = @altThreshold1 * 2.5
		distThreshold2 = @altThreshold2 / 4

		PeR = @/sma * (1 - @/ecc)
		ApR = @/sma * (1 + @/ecc)
		r1 = @/targetBody.Radius() + @/targetBody.AtmosphereAltitude()
		v0 = Pow(@/targetBody.GM() * 3/(2*@r1), 0.5)
		v1 = Pow(@/targetBody.GM() * (2/@r1 - 2/(@r1 + @ApR)), 0.5)
		v2 = Pow(@/targetBody.GM() * (2/@ApR - 2/(@r1 + @ApR)), 0.5)
		v3 = Pow(@/targetBody.GM() * (2/@ApR - 2/@sma), 0.5)
		deltaV = (@v1 - @v0) + (@v3 - @v2)
	}

	DATA
	{
		type = long

		intPe = Max(0, Round(@/PeR - @/targetBody.Radius()))
		intAp = Max(0, Round(@/ApR - @/targetBody.Radius()))
		kmDistThreshold1 = Round(@/distThreshold1 / 1000)
	}

	PARAMETER
	{
		name = Satellite
		type = VesselParameterGroup

		define = @/sat

		PARAMETER
		{
			name = NewVessel
			type = NewVessel
		}

		PARAMETER
		{
			name = HasCrew
			type = HasCrew
			minCrew = 0
			maxCrew = 0
		}

		PARAMETER
		{
			name = HasAntenna
			type = HasAntenna
			minAntennaPower = 3000000000
			antennaType = TRANSMIT
		}

		PARAMETER
		{
			name = PowerGenerator
			type = Any
			title = Have solar panels onboard
			hideChildren = !@Constellations:DEBUG

			PARAMETER
			{
				name = StockSolarGenerator
				type = PartValidation
				partModule = ModuleDeployableSolarPanel
				minCount = 1
			}
		
			PARAMETER:NEEDS[NearFutureSolar]
			{
				name = NFSolarGenerator
				type = PartValidation
				partModule = ModuleCurvedSolarPanel
				minCount = 1
			}
		
			PARAMETER:NEEDS[Kopernicus]
			{
				name = KopernicusSolarGenerator
				type = PartValidation
				partModule = KopernicusSolarPanel
				minCount = 1
			}
		}

		PARAMETER
		{
			name = Orbit
			type = Orbit

			minPeA = Max(0, @/intPe - @/altThreshold1)
			maxPeA = @/intPe + @/altThreshold1
			minApA = Max(0, @/intAp - @/altThreshold1)
			maxApA = @/intAp + @/altThreshold1

			minInclination = Max(0, @/inc - 0.1)
			maxInclination = @/inc + 0.1
		}

		PARAMETER
		{
			name = Rendezvous
			type = Rendezvous

			title = Keep the satellite within @/kmDistThreshold1.Print() km of the marker
			hideChildren = !@Constellations:DEBUG

			disableOnStateChange = false

			vessel = Kolynia Satellite Marker
			distance = @/distThreshold1
		}

		duration = 2d
	}

	PARAMETER
	{
		name = Precision1
		type = VesselParameterGroup

		vessel = @/sat

		title = "Match target orbit with less than "+@/altThreshold1.ToString("N0")+" m deviation (Optional)"

		optional = True
		rewardReputation = @Constellations:precisionReputation
		rewardFunds = @Constellations:precisionFunds

		PARAMETER
		{
			name = Precision1Orbit
			type = Orbit
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			minPeA = Max(0, @/intPe - @/altThreshold1)
			maxPeA = @/intPe + @/altThreshold1
			minApA = Max(0, @/intAp - @/altThreshold1)
			maxApA = @/intAp + @/altThreshold1
		}

		duration = 2s
	}

	PARAMETER
	{
		name = Precision2
		type = VesselParameterGroup

		vessel = @/sat

		title = "Match target orbit with less than "+@/altThreshold2.ToString("N0")+" m deviation (Optional)"

		optional = True
		rewardReputation = 2 * @Constellations:precisionReputation
		rewardFunds = 2 * @Constellations:precisionFunds

		PARAMETER
		{
			name = Precision2Orbit
			type = Orbit
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			minPeA = Max(0, @/intPe - @/altThreshold2)
			maxPeA = @/intPe + @/altThreshold2
			minApA = Max(0, @/intAp - @/altThreshold2)
			maxApA = @/intAp + @/altThreshold2
		}

		duration = 2s
	}

	PARAMETER
	{
		name = Precision3
		type = VesselParameterGroup

		vessel = @/sat

		title = "Place the satellite within "+@/distThreshold2.ToString("N0")+" m of the marker (Optional)"

		optional = True
		rewardReputation = @Constellations:precisionReputation
		rewardFunds = @Constellations:precisionFunds

		PARAMETER
		{
			name = Precision3Rendezvous
			type = Rendezvous
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			vessel = Kolynia Satellite Marker
			distance = @/distThreshold2
		}
	}

	BEHAVIOUR
	{
		name = DestroyVessel
		type = DestroyVessel
		onState = CONTRACT_COMPLETED
		vessel = Kolynia Satellite Marker
	}
}
