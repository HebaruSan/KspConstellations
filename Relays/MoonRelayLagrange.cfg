CONTRACT_TYPE
{
	DATA_EXPAND
	{
		type = String
		point = ["L4", "L5"]
	}

	sortKey = d

	name = ConstellationsMoonRelayLagrange
	group = RelayConstellations

	genericTitle = Establish relay at moon's @/point Lagrange point
	title = Establish relay at @/targetBody's @/point Lagrange point
	description = "Our client wants a stationary relay in orbit of @targetBody which is a problem since a stationary orbit is not possible for @targetBody"+". Luckily, we managed to convince them that a relay in the "+@/point+" Lagrange point would functionally be the same. \nYour job is to establish said relay."

	maxSimultaneous = 1

	synopsis = Place a relay satellite at a @/point point of @/targetBody
	genericDescription = Place a relay satellite at @/point point of a moon

	completedMessage = The relay is in position and working!

	prestige = Trivial

	targetBody = @/tidalMoon

	rewardScience = 0
	rewardReputation = @RelayConstellations:moonRelayReputation
	rewardFunds = @RelayConstellations:moonRelayFunds
	advanceFunds = @rewardFunds / 3
	failureReputation = @rewardReputation
	failureFunds = @advanceFunds

	DATA
	{
		type = Boolean
		coMoon = HomeWorld().Parent().IsPlanet()
		hidden = True
	}

	DATA
	{
		type = CelestialBody
		tidalMoon = (@/coMoon ? HomeWorld().Parent().Children() : HomeWorld().Children()).Where(b => (b.Orbit().Period() == b.RotationalPeriod())).SelectUnique()
		uniquenessCheck = CONTRACT_ALL

		title = "Target body must be "+HomeWorld()+"'s tidally locked moon or co-moon without a relay at the point already"
	}

	REQUIREMENT
	{
		name = Orbit
		type = Orbit
	}

	REQUIREMENT
	{
		name = Rendezvous
		type = Rendezvous

		targetBody = HomeWorld()
	}

	// don't spam contracts before first relay unlocks
	REQUIREMENT
	{
		name = TechResearched
		type = TechResearched

		part = HighGainAntenna5
	}

	DATA
	{
		type = double
		requiredAntennaPower = Pow(@/targetBody.Orbit().Apoapsis() + @/targetBody.SphereOfInfluence() + (@/coMoon ? HomeWorld().Orbit().Apoapsis() : 0), 2) / 2000000000 // assume 2G at home
	}

	DATA
	{
		type = string
		marker = @/targetBody+" "+@/point+" Relay Marker"
		hidden = true
	}

	BEHAVIOUR
	{
		name = SpawnVessel
		type = SpawnVessel

		VESSEL
		{
			name = @/marker
			craftPart = constellations-dummy
			owned = False
			targetBody = @/targetBody.Parent()
			vesselType = DroppedPart

			ORBIT
			{
				SMA = @/targetBody.Orbit().SemiMajorAxis()
				ECC = @/targetBody.Orbit().Eccentricity() + 1.0E-10
				INC = @/targetBody.Orbit().Inclination() + 1.0E-10
				LPE = @/targetBody.Orbit().ArgumentOfPeriapsis()
				LAN = @/targetBody.Orbit().LAN() + 1.0E-10
				MNA = @/targetBody.Orbit().MeanAnomalyAtEpoch() - 5.23598775598 * (@/point == "L4" ? 1 : -1)
				EPH = @/targetBody.Orbit().Epoch() + 1.0E-10
				REF = 0 // ignored
			}
		}
	}

	PARAMETER
	{
		name = Relay
		type = VesselParameterGroup

		define = "the @/targetBody Lagrange relay"
		defineList = (@/point == "L4" ? constellations_l4_relays : constellations_l5_relays)

		PARAMETER
		{
			name = NewVessel
			type = NewVessel
		}

		PARAMETER
		{
			name = VesselIsType
			type = VesselIsType
			vesselType = Relay
		}

		PARAMETER
		{
			name = HasCrew
			type = HasCrew
			minCrew = 0
			maxCrew = 0
		}

		PARAMETER
		{
			name = HasAntenna
			type = HasAntenna
			minAntennaPower = @/requiredAntennaPower
			antennaType = RELAY
		}

		PARAMETER
		{
			name = Any
			type = Any
			title = Have a power generator onboard

			PARAMETER
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more solar panels
				hideChildren = !@Constellations:DEBUG
				partModule = ModuleDeployableSolarPanel
				minCount = 1
			}

			PARAMETER
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more generators
				hideChildren = !@Constellations:DEBUG
				partModule = ModuleGenerator
				minCount = 1
			}

			PARAMETER:NEEDS[NearFutureSolar]
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more curved solar panels
				hideChildren = !@Constellations:DEBUG
				partModule = ModuleCurvedSolarPanel
				minCount = 1
			}

			PARAMETER:NEEDS[NearFutureElectrical]
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more fission reactors
				hideChildren = !@Constellations:DEBUG
				partModule = FissionReactor
				minCount = 1
			}

			PARAMETER:NEEDS[NearFutureElectrical]
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more radioisotope generators
				hideChildren = !@Constellations:DEBUG
				partModule = ModuleRadioisotopeGenerator
				minCount = 1
			}

			PARAMETER:NEEDS[Kopernicus]
			{
				name = PartValidation
				type = PartValidation
				title = 1 or more solar panels
				hideChildren = !@Constellations:DEBUG
				partModule = KopernicusSolarPanel
				minCount = 1
			}
		}

		PARAMETER
		{
			name = Orbit
			type = Orbit

			targetBody = @/targetBody.Parent()

			minPeA = @/targetBody.Orbit().Periapsis()*0.99
			maxApA = @/targetBody.Orbit().Apoapsis()*1.01

			minInclination = Max(0, @/targetBody.Orbit().Inclination() - 0.1)
			maxInclination = Min(180, @/targetBody.Orbit().Inclination() + 0.1)
		}

		PARAMETER
		{
			name = Rendezvous
			type = Rendezvous

			title = Place the relay within 15km of the marker
			hideChildren = !@Constellations:DEBUG

			disableOnStateChange = true

			vessel = @/marker
			distance = 15000
		}

		duration = 2d
	}

	DATA
	{
		type = double
		intAlt = Round(@/targetBody.Orbit().Apoapsis(), 1)
	}

	PARAMETER
	{
		name = Precision1
		type = VesselParameterGroup

		REQUIREMENT
		{
			name = CircularOrbit
			type = Expression

			title = Target body must have a circular orbit
			expression = @/targetBody.Orbit().Eccentricity() == 0
		}

		vessel = "the @/targetBody Lagrange relay"

		title = "Circularize at "+@/intAlt.ToString("0.##")+"m with less than 200m deviation (Optional)"

		optional = True
		rewardReputation = @RelayConstellations:precisionReputation
		rewardFunds = @RelayConstellations:precisionFunds

		PARAMETER
		{
			name = Precision1Orbit
			type = Orbit
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			targetBody = @/targetBody.Parent()

			minPeA = Max(0, @/intAlt - 200)
			maxApA = @/intAlt + 200
		}

		duration = 5s
	}

	PARAMETER
	{
		name = Precision2
		type = VesselParameterGroup

		REQUIREMENT
		{
			name = CircularOrbit
			type = Expression

			title = Target body must have a circular orbit
			expression = @/targetBody.Orbit().Eccentricity() == 0
		}

		vessel = "the @/targetBody Lagrange relay"

		title = "Circularize at "+@/intAlt.ToString("0.##")+"m with less than 1m deviation (Optional)"

		optional = True
		rewardReputation = 2 * @RelayConstellations:precisionReputation
		rewardFunds = 2 * @RelayConstellations:precisionFunds

		PARAMETER
		{
			name = Precision2Orbit
			type = Orbit
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			targetBody = @/targetBody.Parent()

			minPeA = Max(0, @/intAlt - 0.5)
			maxApA = @/intAlt + 0.5
		}

		duration = 5s
	}

	PARAMETER
	{
		name = Precision3
		type = VesselParameterGroup

		vessel = "the @/targetBody Lagrange relay"

		title = Place the relay within 100m of the marker (Optional)

		optional = True
		rewardReputation = @RelayConstellations:ksoPrecisionReputation
		rewardFunds = @RelayConstellations:ksoPrecisionFunds

		PARAMETER
		{
			name = Precision3Rendezvous
			type = Rendezvous
			hidden = !@Constellations:DEBUG
			hideChildren = !@Constellations:DEBUG

			vessel = @/marker
			distance = 100
		}
	}

	BEHAVIOUR
	{
		name = DestroyVessel
		type = DestroyVessel
		onState = CONTRACT_COMPLETED
		vessel = @/marker
	}
}
